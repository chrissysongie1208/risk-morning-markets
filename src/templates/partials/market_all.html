{# Combined partial for position, orderbook, and trades - reduces 3 HTTP requests to 1 #}

{# Position section - primary target (replaces innerHTML of polling div) #}
{# data-position used by JS to detect trade fills #}
<div id="position-content" class="position-hero" data-position="{{ position.net_quantity if position else 0 }}">
{% if position and position.net_quantity != 0 %}
    <div class="position-qty {% if position.net_quantity > 0 %}position-long{% else %}position-short{% endif %}">
        {{ "+" if position.net_quantity > 0 else "" }}{{ position.net_quantity }} lots
    </div>
    <div class="position-avg">
        {% if position.net_quantity > 0 %}LONG{% else %}SHORT{% endif %}
        @ ${{ "%.2f"|format((position.total_cost / position.net_quantity)|abs) }}
    </div>
{% else %}
    <div class="position-qty position-flat">FLAT</div>
    <div class="position-avg">No position</div>
{% endif %}
</div>

{# Orderbook section - OOB swap - Price Ladder Layout #}
<div id="orderbook" hx-swap-oob="innerHTML">
{#
Price Ladder: vertical layout with price in center
- Offers (sell orders) at top, sorted by price descending (highest offers first)
- Spread gap in middle
- Bids (buy orders) at bottom, sorted by price descending (best bid first)
- Layout: [Action] Bids | PRICE | Offers [Action]

Aggregation: Orders from the SAME user at the SAME price are aggregated into one row
showing combined quantity. Different users at same price show as separate rows
(important for queue priority visibility). The Trade/Cancel buttons reference the
first order in queue priority (oldest).
#}

{# Build aggregated offers by user_id + price, preserving time priority #}
{# Key: (user_id, price), Value: {first_order, total_qty, display_name} #}
{% set aggregated_offers = {} %}
{% for order in offers %}
    {% set key = (order.user_id, order.price) %}
    {% if key not in aggregated_offers %}
        {% set _ = aggregated_offers.update({key: {'first_order': order, 'total_qty': order.remaining_quantity, 'display_name': order.display_name}}) %}
    {% else %}
        {% set _ = aggregated_offers[key].update({'total_qty': aggregated_offers[key]['total_qty'] + order.remaining_quantity}) %}
    {% endif %}
{% endfor %}

{# Build aggregated bids by user_id + price, preserving time priority #}
{% set aggregated_bids = {} %}
{% for order in bids %}
    {% set key = (order.user_id, order.price) %}
    {% if key not in aggregated_bids %}
        {% set _ = aggregated_bids.update({key: {'first_order': order, 'total_qty': order.remaining_quantity, 'display_name': order.display_name}}) %}
    {% else %}
        {% set _ = aggregated_bids[key].update({'total_qty': aggregated_bids[key]['total_qty'] + order.remaining_quantity}) %}
    {% endif %}
{% endfor %}

{# Convert to sorted lists for display #}
{#
Queue Priority Display Logic:
- Orders are sorted by price (best price first for each side)
- Within same price level, orders are sorted by time (first-in-first-out)
- BIDS: First person to bid at price X appears at TOP of that price level (closer to spread)
- OFFERS: First person to offer at price X appears at BOTTOM of that price level (closer to spread)
This reflects actual fill priority - the matching engine uses price-time priority.
#}

{# Offers: sort by price DESC (highest at top), then by created_at DESC (oldest at bottom of same price) #}
{# This means first-to-offer is at bottom of each price level = closer to spread #}
{% set offer_rows_unsorted = aggregated_offers.values()|list %}
{% set offer_rows = offer_rows_unsorted|sort(attribute='first_order.created_at', reverse=true)|sort(attribute='first_order.price', reverse=true) %}

{# Bids: sort by price DESC (best bid at top), then by created_at ASC (oldest at top of same price) #}
{# This means first-to-bid is at top of each price level = closer to spread #}
{% set bid_rows_unsorted = aggregated_bids.values()|list %}
{% set bid_rows = bid_rows_unsorted|sort(attribute='first_order.created_at')|sort(attribute='first_order.price', reverse=true) %}

{# Get best bid and best offer for spread display #}
{% set best_bid = bids[0].price if bids else none %}
{% set best_offer = offers[0].price if offers else none %}

{% if bids or offers %}
<table class="price-ladder">
    <thead>
        <tr>
            <th class="ladder-action"></th>
            <th class="ladder-bid-info">Bids</th>
            <th class="ladder-price">Price</th>
            <th class="ladder-offer-info">Offers</th>
            <th class="ladder-action"></th>
        </tr>
    </thead>
    <tbody>
        {# Offers section - highest price first #}
        {% for agg in offer_rows %}
        {% set order = agg['first_order'] %}
        <tr class="ladder-offer-row{% if order.user_id == user.id %} own-order{% endif %}">
            <td class="ladder-action">
                {# Empty on bid side for offer rows #}
            </td>
            <td class="ladder-bid-info">
                {# Empty bid side #}
            </td>
            <td class="ladder-price offer">{{ "%.2f"|format(order.price) }}</td>
            <td class="ladder-offer-info">
                <span class="ladder-qty">{{ agg['total_qty'] }}</span>
                <span class="ladder-user">{{ agg['display_name'] }}{% if order.user_id == user.id %} <small>(you)</small>{% endif %}</span>
            </td>
            <td class="ladder-action">
                {% if order.user_id == user.id and market.status.value == 'OPEN' %}
                <form hx-post="/orders/{{ order.id }}/cancel" hx-swap="none" style="display:inline;">
                    <button type="submit" class="outline secondary ladder-btn" title="Cancel your offer">
                        <span class="btn-spinner spinner" style="width:0.7em;height:0.7em;border-width:1px;"></span>
                        <span class="btn-text">Cancel</span>
                    </button>
                </form>
                {% elif order.user_id != user.id and market.status.value == 'OPEN' %}
                <form hx-post="/orders/{{ order.id }}/aggress" hx-swap="none" style="display:inline;" class="aggress-form">
                    <input type="hidden" name="quantity" class="aggress-qty">
                    <input type="hidden" name="fill_and_kill" class="aggress-fak" value="false">
                    <button type="submit" class="ladder-btn ladder-buy-btn" title="Buy this offer">
                        <span class="btn-spinner spinner" style="width:0.7em;height:0.7em;border-width:1px;"></span>
                        <span class="btn-text">Buy</span>
                    </button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}

        {# Spread row #}
        <tr class="ladder-spread-row">
            <td colspan="5" class="ladder-spread">
                {% if best_bid and best_offer %}
                    <span class="spread-label">Spread: {{ "%.2f"|format(best_offer - best_bid) }}</span>
                {% else %}
                    <span class="spread-label">---</span>
                {% endif %}
            </td>
        </tr>

        {# Bids section - highest price first #}
        {% for agg in bid_rows %}
        {% set order = agg['first_order'] %}
        <tr class="ladder-bid-row{% if order.user_id == user.id %} own-order{% endif %}">
            <td class="ladder-action">
                {% if order.user_id == user.id and market.status.value == 'OPEN' %}
                <form hx-post="/orders/{{ order.id }}/cancel" hx-swap="none" style="display:inline;">
                    <button type="submit" class="outline secondary ladder-btn" title="Cancel your bid">
                        <span class="btn-spinner spinner" style="width:0.7em;height:0.7em;border-width:1px;"></span>
                        <span class="btn-text">Cancel</span>
                    </button>
                </form>
                {% elif order.user_id != user.id and market.status.value == 'OPEN' %}
                <form hx-post="/orders/{{ order.id }}/aggress" hx-swap="none" style="display:inline;" class="aggress-form">
                    <input type="hidden" name="quantity" class="aggress-qty">
                    <input type="hidden" name="fill_and_kill" class="aggress-fak" value="false">
                    <button type="submit" class="ladder-btn ladder-sell-btn" title="Sell to this bid">
                        <span class="btn-spinner spinner" style="width:0.7em;height:0.7em;border-width:1px;"></span>
                        <span class="btn-text">Sell</span>
                    </button>
                </form>
                {% endif %}
            </td>
            <td class="ladder-bid-info">
                <span class="ladder-user">{{ agg['display_name'] }}{% if order.user_id == user.id %} <small>(you)</small>{% endif %}</span>
                <span class="ladder-qty">{{ agg['total_qty'] }}</span>
            </td>
            <td class="ladder-price bid">{{ "%.2f"|format(order.price) }}</td>
            <td class="ladder-offer-info">
                {# Empty offer side #}
            </td>
            <td class="ladder-action">
                {# Empty on offer side for bid rows #}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="ladder-empty"><small>No orders in the book</small></p>
{% endif %}
</div>

{# Trades section - OOB swap #}
<div id="trades" hx-swap-oob="innerHTML">
{% if trades %}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Buyer</th>
            <th>Seller</th>
            <th>Price</th>
            <th>Qty</th>
        </tr>
    </thead>
    <tbody>
        {% for trade in trades %}
        <tr>
            <td><small>{{ trade.created_at.strftime('%H:%M:%S') }}</small></td>
            <td>{{ trade.buyer_name }}</td>
            <td>{{ trade.seller_name }}</td>
            <td>{{ "%.2f"|format(trade.price) }}</td>
            <td>{{ trade.quantity }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p><small>No trades yet</small></p>
{% endif %}
</div>
