{% extends "base.html" %}

{% block title %}{{ market.question[:50] }} - Morning Markets{% endblock %}

{% block extra_head %}
<script>
// Trade fill detection and feedback
(function() {
    let previousPosition = null;
    let audioContext = null;
    let soundEnabled = false;

    // Initialize audio on first user interaction (required by browsers)
    function initAudio() {
        if (audioContext) return;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            soundEnabled = true;
        } catch (e) {
            console.log('Web Audio not supported');
        }
    }

    // Play a simple beep using Web Audio API
    function playBeep(isBuy) {
        if (!audioContext || !soundEnabled) return;

        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Higher pitch for buy, lower for sell
            oscillator.frequency.value = isBuy ? 880 : 440;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        } catch (e) {
            console.log('Audio error:', e);
        }
    }

    // Flash the position box
    function flashPosition(isBuy) {
        const positionBox = document.getElementById('position-content');
        if (!positionBox) return;

        // Remove any existing flash class
        positionBox.classList.remove('flash-buy', 'flash-sell');

        // Force reflow to restart animation
        void positionBox.offsetWidth;

        // Add appropriate flash class
        positionBox.classList.add(isBuy ? 'flash-buy' : 'flash-sell');
    }

    // Enable audio on first click anywhere on page
    document.addEventListener('click', initAudio, { once: true });

    // Listen for HTMX after-swap events to detect position changes
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Only process swaps that affect the position
        if (!event.detail.target || event.detail.target.id !== 'position-content') return;

        const positionContent = document.getElementById('position-content');
        if (!positionContent) return;

        const newPosition = parseInt(positionContent.dataset.position || '0', 10);

        // Skip the first load (no previous value to compare)
        if (previousPosition === null) {
            previousPosition = newPosition;
            return;
        }

        // Detect if position changed (trade happened)
        if (newPosition !== previousPosition) {
            const isBuy = newPosition > previousPosition;
            playBeep(isBuy);
            flashPosition(isBuy);
        }

        previousPosition = newPosition;
    });
})();
</script>
{% endblock %}

{% block content %}
<article>
    <header>
        <h1>{{ market.question }}</h1>
        {% if market.description %}
            <p>{{ market.description }}</p>
        {% endif %}
        <p>
            <span class="market-status {{ market.status.value|lower }}">{{ market.status.value }}</span>
            {% if market.status.value == 'SETTLED' %}
                | Settlement Value: <strong>{{ market.settlement_value }}</strong>
            {% endif %}
        </p>
    </header>

    {% if error %}
        <p class="error">{{ error }}</p>
    {% endif %}
    {% if success %}
        <p class="success">{{ success }}</p>
    {% endif %}

    {% if market.status.value == 'OPEN' %}
    <!-- Order Placement Form -->
    <section>
        <h3>Place Order</h3>
        <form method="POST" action="/markets/{{ market.id }}/orders">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <label>
                    Side
                    <select name="side" required>
                        <option value="BID">BID (Buy)</option>
                        <option value="OFFER">OFFER (Sell)</option>
                    </select>
                </label>
                <label>
                    Price
                    <input type="number" name="price" step="0.01" min="0.01" required placeholder="100.00">
                </label>
                <label>
                    Quantity
                    <input type="number" name="quantity" min="1" max="{{ position_limit }}" required placeholder="5">
                </label>
                <button type="submit">Submit Order</button>
            </div>
        </form>
        <small>Position limit: {{ position_limit }} lots. Your current position: {{ position.net_quantity if position else 0 }} lots.</small>
    </section>

    {% if user.is_admin %}
    <!-- Admin: Settle Market Form -->
    <section style="border: 2px solid var(--pico-primary); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
        <h3>Admin: Settle Market</h3>
        <form method="POST" action="/admin/markets/{{ market.id }}/settle">
            <div style="display: grid; grid-template-columns: 2fr auto; gap: 1rem; align-items: end;">
                <label>
                    Settlement Value (actual answer)
                    <input type="number" name="settlement_value" step="any" required placeholder="e.g., 1002">
                </label>
                <button type="submit"
                        onclick="return confirm('Settle this market? This will close the market, cancel all open orders, and calculate final P&L. This cannot be undone.')">
                    Settle Market
                </button>
            </div>
        </form>
        <small>Settling will close the market and calculate P&L for all participants.</small>
    </section>
    {% endif %}

    {% elif market.status.value == 'CLOSED' %}
    <p><em>This market is closed. Waiting for settlement.</em></p>
    {% else %}
    <p><em>This market has been settled. <a href="/markets/{{ market.id }}/results">View Results</a></em></p>
    {% endif %}

    <!-- Current Position (HTMX polling - triggers combined update) -->
    <section>
        <h3>Your Position</h3>
        <div id="position"
             hx-get="/partials/market/{{ market.id }}"
             hx-trigger="every 1s"
             hx-swap="innerHTML"
             hx-target="#position-content">
            <div id="position-content">
            {% include 'partials/position.html' %}
            </div>
        </div>
    </section>

    <!-- Order Book (updated via hx-swap-oob from combined endpoint) -->
    <section>
        <h3>Order Book</h3>
        <div id="orderbook">
            {% include 'partials/orderbook.html' %}
        </div>
    </section>

    <!-- Recent Trades (updated via hx-swap-oob from combined endpoint) -->
    <section>
        <h3>Recent Trades</h3>
        <div id="trades">
            {% include 'partials/trades.html' %}
        </div>
    </section>
</article>

<footer>
    <p><a href="/markets">‚Üê Back to Markets</a></p>
</footer>
{% endblock %}
